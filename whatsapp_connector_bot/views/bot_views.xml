<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <record id="whatsapp_connector_bot_search" model="ir.ui.view">
        <field name="name">acrux.chat.bot.search</field>
        <field name="model">acrux.chat.bot</field>
        <field name="arch" type="xml">
            <search string="ChatBot">
                <field name="bot_key" />
                <field name="name" />
                <field name="complete_name" />
                <field name="complete_name" string="Child of" filter_domain="[('complete_name', 'ilike', self)]" />
                <filter string="Root Bot" name="only_root" domain="[('parent_id', '=', False)]" />
                <filter string="One Level Bot" name="one_level" domain="['|', ('parent_id', '=', False), ('parent_id.parent_id', '=', False)]" />
                <separator />
                <filter string="All" name="all" domain="['|', ('active', '=', False), ('active', '=', True)]" />
            </search>
        </field>
    </record>

    <record model="ir.ui.view" id="whatsapp_connector_bot_tree">
        <field name="name">acrux.chat.bot.list</field>
        <field name="model">acrux.chat.bot</field>
        <field name="arch" type="xml">
            <list class="chat_bot_tree">
                <field name="seq" invisible="1" />  <!-- invisible: widget -->
                <field name="sequence" widget="handle" />
                <field name="is_ai"/>
                <field name="bot_key" string="Key" optional="show" />
                <field name="show_name" widget="html" />
                <field name="body_whatsapp" optional="hide" />
                <field name="code" optional="hide" />
                <field name="reminder_ids" optional="hide" widget="many2many_tags" />
                <field name="connector_id" widget="selection" optional="hide" />
                <field name="apply_from" widget="float_time" optional="hide" />
                <field name="apply_to" widget="float_time" optional="hide" />
                <field name="apply_weekday" optional="hide" />
                <field name="mute_minutes" string="Mute" optional="show" />
                <field name="active" widget="boolean_toggle" />
                <field name="name" column_invisible="1" />  <!-- invisible: ignore -->
                <field name="parent_id" column_invisible="1" />  <!-- invisible: ignore -->
                <field name="complete_name" column_invisible="1" force_save="1" />  <!-- invisible: ignore -->
            </list>
        </field>
    </record>

    <record model="ir.ui.view" id="whatsapp_connector_bot_form">
        <field name="name">acrux.chat.bot.form</field>
        <field name="model">acrux.chat.bot</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="import_product" type="object" string="Import Products"
                        invisible="is_product == False"
                        class="btn-primary" help="Create children with products imported." />
                </header>
                <sheet class="acrux_clean_sheet">
                    <field name="product_image" widget="image" class="acrux_oe_avatar"
                        invisible="is_product == False" />
                    <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger" invisible="active"/>
                    <group>
                        <group>
                            <div class="w-100" colspan="2">
                                <field name="id" invisible="1" />  <!-- invisible: ignore -->
                                <field name="sequence" invisible="1" />  <!-- invisible: ignore -->
                                <field name="child_ids" invisible="1" />  <!-- invisible: ignore -->
                                <field name="count_childs" invisible="1" />  <!-- invisible: ignore -->
                                <field name="complete_name" invisible="1" />  <!-- invisible: ignore -->
                                <field name="show_name" invisible="1" />  <!-- invisible: ignore -->
                                <h1>
                                    <field name="name" default_focus="1" placeholder="Reference" nolabel="1"/>
                                </h1>
                            </div>
                            <field name="parent_id" options="{'no_create': True}" domain="[('id', '!=', id)]"
                                context="{'active_test': False}" />
                            <field name="bot_key" class="w-50"/>
                            <field name="is_product" widget="boolean_toggle" invisible="1"/>  <!-- invisible: compute below -->
                            <field name="product_id" options="{'no_create': True}"
                                invisible="is_product == False"
                                required="is_product == True" />
                            <field name="product_image_send" widget="boolean_toggle"
                                invisible="is_product == False or product_id == False" />
                        </group>
                        <group>
                            <group col="1" colspan="2">
                                <group>
                                    <field name="active" widget="boolean_toggle" />
                                </group>
                                <group>
                                    <group>
                                        <field name="is_ai" widget="boolean_toggle" readonly="1"/>
                                    </group>
                                    <group>
                                        <field name="ai_connector_id"
                                               invisible="is_ai == False"
                                               required="is_ai == True"
                                               options="{'no_create': True, 'no_open': True}"/>
                                    </group>
                                </group>
                            </group>
                        </group>
                    </group>
                    <notebook class="mt-4">
                        <page string="Message" name='basic' invisible="is_ai == True">
                            <group class="mx-0">
                                <group string="Apply if" class="acrux_bot bot_bg_color_red mt-2">
                                    <group>
                                        <field name="text_match" />
                                        <field name="mute_minutes" />
                                        <field name="connector_id" widget="selection" domain="[('use_ai', '=', False)]"/>
                                    </group>
                                    <group>
                                       <field name="apply_from" widget="float_time" />
                                        <field name="apply_to" widget="float_time" />
                                        <field name="apply_weekday" />
                                    </group>
                                </group>
                                <group col="1">
                                    <div class="mt-2 ms-4 text-muted text-nowrap">
                                        <i><b>Use this BOT or analyze the next one?</b><br/><br/><ul>
<li>In this section you can configure whether this BOT<br/>
is processed or should be continued with the next BOT.</li>
<li>Leaving empty or default values means that this BOT <br/>
will be executed and not continue to the next one.</li></ul></i>
                                    </div>
                                </group>
                                <group string="Message">
                                    <field name="body_whatsapp" invisible="ws_template_id != False" force_save="1" />
                                    <field name="body_whatsapp_html" force_save="1" readonly="1"
                                        string="Message"
                                        invisible="ws_template_id == False"
                                        widget="html" options="{'style-inline': true, 'codeview': true}" />
                                    <field name="attachment_ids" widget="many2many_binary" class="oe_inline" />
                                    <field name="ws_template_id"
                                        invisible="is_product == False"
                                        required="is_product == True or bot_model_id != False" />
                                </group>
                                <group invisible="1">
                                    <field name="bot_model_real" force_save="1" />
                                    <field name="bot_model_id" options="{'no_create': True, 'no_open': True}"
                                        force_save="1" />
                                    <field name="bot_res_id"
                                        required="bot_model_id != False"
                                        force_save="1"
                                        options="{'model_field': 'bot_model_real'}" />
                                </group>
                            </group>
                            <div invisible="count_childs == 0">
                                <label for="reminder_ids" />
                                <field name="reminder_ids">
                                    <list>
                                        <field name="name" optional="show" />
                                        <field name="minutes" />
                                        <field name="exit_bot" />
                                        <field name="to_done" />
                                        <field name="code" widget="ace" options="{'mode': 'python'}" optional="show" />
                                    </list>
                                    <form>
                                        <group>
                                            <field name="minutes" />
                                            <field name="name" />
                                            <field name="exit_bot" />
                                            <field name="to_done" />
                                            <field name="code" widget="ace" options="{'mode': 'python'}" />
                                            <div style="margin-top: 32px;">
                                                <p class="text-900">Help with Python expressions</p>
                                                <p>Various fields may use Python code or Python expressions. The following variables can be used:</p>
                                                <ul>
                                                    <li><code>env</code>: Odoo Environment.</li>
                                                    <li><code>conv_id</code>: Conversation record on which the action is triggered</li>
                                                    <li><code>email_re</code>: Search email in string</li>
                                                    <li><code>now_local</code>: datetime in local time</li>
                                                    <li><code>datetime</code>, <code>dateutil</code>, <code>timezone</code>: useful Python libraries</li>
                                                    <li><code>random_choice</code>: <code>random.choice</code> Python library</li>
                                                    <li>Return: <code>ret = {'send_text': 'Text'}</code></li>
                                                    <li>Keys to return: <ul>
                                                            <li><b>send_text</b>: Text of the message.</li>
                                                        </ul>
                                                    </li>
                                                </ul>
                                                <div style="margin-top: 16px;">Example:</div>
                                                <div style="white-space: pre-wrap; font-size: 90%; color: #e83e8c;">text = 'Hello %s' % conv_id.name
                                                    ret = {'send_text': text}
                                                </div>
                                            </div>
                                        </group>
                                    </form>
                                </field>
                            </div>
                        </page>
                        <page string="Advanced" name='code' invisible="is_ai == True">
                            <group>
                                <field name="code" widget="ace" options="{'mode': 'python'}" />
                            </group>
                        </page>
                        <page string="Help" name="help_info" invisible="is_ai == True">
                            <group class="mt32 o_group_col_12" col="1" colspan="4">
                                <div style="margin-top: 4px;">
                                    <h3>Help with Python expressions</h3>
                                    <p>Various fields may use Python code or Python expressions. The following variables can be used:</p>
                                    <ul>
                                        <li><code>env</code>: Odoo Environment on which the action is triggered</li>
                                        <li><code>text</code>: Text of the Message on which the action is triggered</li>
                                        <li><code>mess_id</code>: Message record on which the action is triggered</li>
                                        <li><code>email_re</code>: Search email in string</li>
                                        <li><code>search_partner</code>: Search partner by cell phone number</li>
                                        <li><code>now_local</code>: datetime in local time</li>
                                        <li><code>datetime</code>, <code>dateutil</code>, <code>timezone</code>: useful Python libraries</li>
                                        <li><code>UserError</code>: Warning Exception to use with <code>raise</code></li>
                                        <li><code>random_choice</code>: <code>random.choice</code> Python library</li>
                                        <li><code>metadata</code>: Dictionary with message metadata (Example: Click on a button)</li>
                                        <li>Return: One <code>ret={...}</code> or Many <code>ret=[{}, {}, ...]</code></li>
                                        <li>Keys to return: <ul>
                                                <li><b>send_text</b>: Text of the message. You can send multiple.</li>
                                                <li><b>send_button</b>: Text + Buttons.</li>
                                                <li><b>goto_and_wait</b>: Go to Bot thread and wait</li>
                                                <li><b>goto_and_send</b>: Go to Bot thread and run</li>
                                                <li><b>next</b>: Continue to the next thread in its level</li>
                                                <li><b>exit</b>: If the current thread has children, don't run and go to the top level.</li>
                                                <li><b>write</b>: Write in Odoo Model</li>
                                                <li><b>create</b>: Create record in Odoo model</li>
                                                <li><b>create_partner</b>: Create partner automatically</li>
                                                <li><b>link_partner</b>: Link partner to this chat</li>
                                                <li><b>log</b>: Create Bot Log line (ret=[{'log': 'my text'}])</li>
                                            </ul>
                                        </li>
                                    </ul>
                                    <div>
                                        <p>
                                            <b>Simple example (Python)</b>
                                        </p>
                                        <div style="white-space: pre-wrap; font-size: 90%; color: #e83e8c;">
                                            <pre>ret = []
<span style="color:gray;"># Search words in received message (text: string)
# Example of received message: text = "What is the address and phone number?"</span>
if 'address' in text:
    <span style="color:gray;"># Send one message</span>
    ret.append({'send_text': 'The address of our company is ...'})
if 'phone number' in text:
    <span style="color:gray;"># Send another message</span>
    ret.append({'send_text': 'Our phone number is +56 67 221 7777'})</pre>
                                            <pre>if not ret:
    <span style="color:gray;"># Send Text + Buttons</span>
    ret.append({'send_button': {
        'text': 'Hello',
        'buttons': [{'btn_id': 'yes', 'text': 'YES'}, {'btn_id': 'no', 'text': 'NO'}]
    }}))</pre>
                                        </div>
                                        <br />
                                        <p>
                                            <b>Advanced example (Python)</b>
                                        </p>
                                        <div style="white-space: pre-wrap; font-size: 90%; color: #e83e8c;">
                                            <pre>ret = []
<span style="color:gray;"># Search email in message (text: string)</span>
emails = email_re.findall(text or '')
if emails:
    <span style="color:gray;"># Send 2 messages:</span>
    ret.append({'send_text': 'All good'})
    ret.append({'send_text': 'Email has been updated (%s)' % emails[0]})

    <span style="color:gray;"># Action (Just one of these or empty):</span>
    ret.append({'next': True})
    ret.append({'exit': True})
    ret.append({'goto_and_wait': '#12'})
    ret.append({'goto_and_send': '#12'})

    <span style="color:gray;"># Write email in Odoo model (You can add multiple lines):</span>
    ret.append({
        'write': {
            'res_model': 'res.partner',
            'res_id': mess_id.contact_id.res_partner_id.id,
            'data': {'email': emails[0]}
        }
    })

    <span style="color:gray;"># Or search and create Partner (You can add multiple lines):</span>
    partner = search_partner()
    if not partner:
        ret.append({'create_partner': True})
else:
    ret.append({'send_text': 'oops, wrong email'}))</pre>
                                        </div>
                                    </div>
                                </div>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record model="ir.actions.act_window" id="whatsapp_connector_bot_action">
        <field name="name">ChatBot</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">acrux.chat.bot</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="whatsapp_connector_bot_tree"/>
        <field name="view_ids"
            eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'list', 'view_id': ref('whatsapp_connector_bot_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('whatsapp_connector_bot_form')})]" />
        <field name="context">{'search_default_all': 1, 'default_is_ai': False}</field>
        <field name="domain">[('is_ai', '=', False)]</field>
    </record>

</odoo>
